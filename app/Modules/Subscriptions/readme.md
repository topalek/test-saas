# Laravel Plans

Laravel Plans - это пакет для приложений типа SaaS, которым требуется удобное управление планами, функциями и
обновлениями планов на основе событий. Если вы планируете продавать свои услуги по подписке, вы находитесь в нужном
месте!

Добавьте трейт `HasPlans` к вашей модели Eloquent:

```php
use App\Modules\Subscriptions\Traits\HasPlans;

class User extends Model {
    use HasPlans;
    ...
}
```

**Примечание: Если вы внесли изменения в модели `plans.php`, убедитесь, что вы используете их и не забудьте расширить
свои модели от них.**

# Что вы можете сделать?

Основной единицей подобной системы подписки является план. Вы можете создать его,
используя `App\Modules\Subscriptions\Models\Plan`.
Если вы расширили его, используйте свою собственную модель, чтобы создать план.

```php
$plan = Plan::create([
    'name' => 'Мой потрясающий план',
    'description' => 'Один из лучших планов здесь.',
    'price' => 9.99,
    'duration' => 30, // в днях
]);
```

С помощью плана вы можете назначать функции (или ограничения) и подписывать вашу модель,
которая имеет трейт `HasPlans`.

Функции представляют собой два типа: `limit` и `feature`:

* `feature` это одна строка, которая не требует подсчета. Например, вы можете хранить разрешения.
* `limit` это число. Для этого будет использоваться поле `limit` и `used`. Оно предназначено для измерения,
  сколько из этой функции использовал владелец. Например, сколько минут сборки было использовано за месяц
  (или за цикл, который в этом примере составляет 30 дней).

```php
$plan->features()->saveMany([
    new Feature([
        'name' => 'Доступ к хранилищу',
        'code' => 'vault.access',
        'description' => 'Предоставление доступа к хранилищу.',
        'type' => 'feature',
    ]),
    new Feature([
        'name' => 'Минуты сборки',
        'code' => 'build.minutes',
        'description' => 'Минуты сборки, используемые для CI/CD.',
        'type' => 'limit',
        'limit' => 2000,
    ]),
    ...
]);
```

# Ограничения и функции

Для использования функции типа `limit` вы можете вызвать метод `consumeFeature()` из экземпляра подписки.
Метод `activeSubscription()`.

Если вы подписали свою модель на план, вы можете использовать метод `activeSubscription()`,
но убедитесь, что проверяете его перед этим:

```php
if($user->hasActiveSubscription()) {
    $user->activeSubscription()->consumeFeature('build.minutes', 10); // использовано 10 минут.
}
```

Метод `consumeFeature()` вернет `null`, если функция не существует, `false`,
если функция не является `limit` или количество превышает текущее разрешение функции, и вернет `true`,
если потребление выполнено.

```php
if($user->hasActiveSubscription()) {
    $user->activeSubscription()->consumeFeature('build.minutes', 2001); // false
    $user->activeSubscription()->consumeFeature('build.hours', 1); // false
    $user->activeSubscription()->consumeFeature('build.minutes', 30); // true
}
```

Кроме того, вы также можете отменить потребление функций. Это метод отмены:

```php
if($user->hasActiveSubscription()) {
    $user->activeSubscription()->consumeFeature('build.minutes', 30); // true

    $user->activeSubscription()->unconsumeFeature('build.hours', 1); // false
    $user->activeSubscription()->unconsumeFeature('build.minutes', 30); // true

    // Теперь количество использованных для этой функции равно 0, остаток составляет 2000
}
```

# Подписка на планы

Вы можете подписать свои модели на план.

```php
// Подписать пользователя на план.
$user->subscribeTo($plan, 30, true);
$user->activeSubscription()->remainingDays(); // 29; это потому, что это 29 дней, 23 часа и так далее.
```

Примечание: если пользователь уже подписан, метод `subscribeTo()` вернет `false`.
Чтобы избежать этого, используйте методы `upgradeTo()` или `extendWith()` для обновления или продления периода подписки.

В методе `subscribeTo()` первый параметр представляет собой экземпляр плана, на который будет подписана модель.
Второй параметр - это период в днях.

Если модель имеет активную подписку, возвращается значение `false`.
Поэтому вы можете использовать метод `upgradeTo()` для изменения плана.

# Обновление на другие планы

```php
$user->upgradeTo($anotherPlan, 60, true);
$user->activeSubscription()->upgradeTo($anotherPlan, 60, true); // псевдоним
```

Первый параметр - это план, на который мы хотим перейти. Второй параметр - это период в днях.
Третий параметр широко используется в пакете, поэтому будьте внимательны: если установлено значение `true`,
вместо создания новой подписки, которая начинается после окончания текущей подписки,
она продлевает текущую на определенное количество дней. Если установлено значение `false`,
будет создана новая подписка в дополнение к текущей.
Если текущая активная подписка истекает завтра, новая подписка начнется завтра, после окончания первой.

Когда речь идет о третьем параметре, мы имеем в виду, будет ли план, на который мы подписываемся,
продлеваться или обновляться, начинаться с "следующего цикла" или "продлеваться текущая подписка".

Для удобства, если пользователь не подписан на какой-либо план,
он будет автоматически подписан при использовании этого метода.

# Продление срока подписки.

Так же, как и методы обновления, этот метод принимает продолжительность и параметр,
чтобы определить, должно ли изменение произойти сейчас или в другом цикле (в будущей подписке, продлении текущей),
после окончания текущей подписки.

```php
$user->extendCurrentSubscriptionWith(60, true); // 60 дней, начинается сейчас
$user->activeSubscription()->extendWith(60, true); // псевдоним
```

# Отмена

Вы можете отменить подписки. Если подписка еще не завершена (она не истекла),
она будет помечена как `pending cancellation`. Она будет полностью отменена,
когда наступит дата истечения срока и она будет отменена.

```php
$user->cancelCurrentSubscription(); // false, если нет активной подписки
$user->activeSubscription()->cancel();

// Это можно проверить позже.
$subscription->isCancelled(); // true, только если она была отменена
$subscription->isPendingCancellation(); // true, если она истекает, то будет false
$subscription->isActive(); // все еще true, если она истекает, то будет false
```

# Связи

Когда вы хотите получить данные о планах, вы можете использовать связи,
созданные в экземпляре `Subscription` (который возвращается в методе `activeSubscription()`)
или в вашей модели, которая использует трейт.

```php
$user = User::find(1);
$user->subscribeTo(Plan::find(1), 30); // Подписаться на план с ID 1, на 30 дней.

$user->subscriptions(); // Все подписки; Связь
$user->currentSubscription(); // Текущая подписка; Связь

// null, если нет активной подписки. Возвращает экземпляр PlanSubscription.
$user->activeSubscription();

// Если у него нет подписок, возвращает null.
// Если есть активная подписка, возвращает экземпляр `PlanSubscription`.
// Если нет активной подписки, возвращает последнюю, даже если она истекла.
$user->lastActiveSubscription();

// Возвращает true, если есть активная подписка, иначе false.
$user->hasActiveSubscription();
```

Чтобы избежать путаницы, экземпляр `Subscription` возвращается в `activeSubscription()`
и `lastActiveSubscription()`. Вы можете вызывать следующие методы в цепочке:

```php
$subscription = $user->activeSubscription();

$subscription->plan(); // Возвращает план этой подписки; Связь
$subscription->features(); // Возвращает функции текущей подписки; Связь
$subscription->usages(); // Возвращает количество использований для функций с ограничением в рамках плана этой подписки.
```

# События

При использовании планов подписки вы можете вызывать события, чтобы автоматически выполнять код,
который может вносить изменения. Например, если пользователь автоматически продлевает свой период до окончания подписки,
вы можете дать ему бесплатные бонусные дни за лояльность.
События легко использовать. Если вы не знакомы с ними, вы можете ознакомиться с
[Официальной документацией Laravel по событиям.](https://laravel.com/docs/10.x/events).

Вам нужно просто реализовать следующие события в файле `EventServiceProvider`:

```php
$listen = [
    ...
    \App\Modules\Subscriptions\Events\CancelSubscription::class => [
    // $event->subscription = Отмененная подписка.
    ],
    \App\Modules\Subscriptions\Events\NewSubscription::class => [
    // $event->subscription = Созданная подписка.
    // $event->duration = Продолжительность подписки в днях.
    ],
    \App\Modules\Subscriptions\Events\ExtendSubscription::class => [
    // $event->subscription = Продленная подписка.
    // $event->duration = Продолжительность подписки в днях.
    // $event->startFromNow = Если подписка продлевается сейчас или создается новая подписка в будущем.
    // $event->newSubscription = Если startFromNow равно false, здесь будет отправлена новая подписка, которая начнется после окончания текущей.
    ],
    \App\Modules\Subscriptions\Events\UpgradeSubscription::class => [
    // $event->subscription = Текущая подписка.
    // $event->duration = Продолжительность обновленной подписки в днях.
    // $event->startFromNow = Если подписка обновляется сейчас или создается новая подписка в будущем.
    // $event->oldPlan = Здесь находится текущий (теперь старый) план.
    // $event->newPlan = Здесь находится новый план. Если это тот же план, он будет совпадать с $event->oldPlan.
    ],
    \App\Modules\Subscriptions\Events\FeatureUsed::class => [
    // $event->subscription = Текущая подписка.
    // $event->feature = Использованная функция.
    // $event->used = Использованное количество.
    // $event->remaining = Общее количество оставшихся.
    ],
    \App\Modules\Subscriptions\Events\FeatureUnconsumed::class => [
    // $event->subscription = Текущая подписка.
    // $event->feature = Возвращенная функция.
    // $event->used = Возвращенное количество.
    // $event->remaining = Общее количество оставшихся.
    ],
];
```
